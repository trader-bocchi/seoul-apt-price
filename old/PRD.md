# 네이버 부동산 매물 수집 및 알림 시스템 PRD

## 1. 프로젝트 개요

### 1.1 목적
네이버 부동산 API를 활용하여 사용자가 입력한 **지역구(동 단위) 전체의 모든 부동산 매물 정보**를 체계적으로 수집하고, **관심 단지에 대한 시세/호가 정보를 텔레그램으로 알림**하는 시스템을 개발합니다.

**핵심 목표**: 
- 입력된 지역구의 모든 매물을 누락 없이 수집하여 실제 네이버 부동산 페이지에 표시되는 매물 개수와 일치하도록 합니다.
- .env에 등록된 관심 단지에 대한 시세 변동을 실시간으로 모니터링하고 알림을 제공합니다.

### 1.2 목표 사용자
- 부동산 투자자
- 부동산 중개업자
- 부동산 시장 분석가
- 관심 단지 시세 모니터링이 필요한 사용자

### 1.3 핵심 가치
- 간편한 지역 검색으로 **지역구 전체 매물** 정보 수집
- **누락 없는 완전한 데이터 수집** (실제 페이지와 일치하는 매물 개수)
- **관심 단지 시세 모니터링 및 텔레그램 알림**
- **가격 변동 알람** (전주/전월/전년 대비)
- CSV 기반 데이터 저장 및 분석 가능

### 1.4 아키텍처 원칙
- **기존 수집 시스템 구조 유지**: ApiRef.md를 기준으로 한 기존 API 호출 방식, 파싱 로직, 수집 파이프라인을 그대로 유지
- **기능 추가 및 확장**: 리팩토링이 아닌 기능 추가 방식으로 구현
- **데이터베이스 미사용**: 모든 데이터는 CSV 파일로 저장

## 2. 기능 요구사항

### 2.1 관심 단지 관리 (요건 1)

#### 2.1.1 .env 파일 기반 단지 관리
- 단지 정보는 코드에 하드코딩하지 않고 `.env` 파일에 저장
- `.env` 파일에는 반드시 다음 두 가지 값이 존재해야 함:
  ```
  CURRENT_HOME_COMPLEX_NAME=현재_거주중인_단지명
  TARGET_HOME_COMPLEX_NAME=향후_거주_희망_단지명1,향후_거주_희망_단지명2,향후_거주_희망_단지명3
  ```
- `TARGET_HOME_COMPLEX_NAME`에는 여러 개의 단지명을 **쉼표(,)로 구분**하여 입력 가능
- 수집 로직은 위 단지명들을 읽어 각각 "현재 거주 단지", "관심 단지(들)"로 구분하여 처리
- 각 관심 단지에 대해 개별적으로 수집 및 분석 수행

#### 2.1.2 단지 필터링 수집
- 일반 수집 시: 지역구 전체 매물 수집 (기존 로직 유지)
- 관심 단지 수집 시: .env에 등록된 단지명과 일치하는 매물만 필터링하여 수집
- 단지명 매칭은 `complex_name` 필드를 기준으로 수행 (부분 일치 허용)

### 2.2 지역 검색 및 매물 수집 (기존 기능 유지)

#### 2.2.1 지역 입력
- **기능**: 사용자가 검색할 **지역구(동 단위)**를 입력할 수 있는 입력 필드 제공
- **입력 방식**:
  - 텍스트 입력: "서울시 강남구 역삼동" 형식의 주소 입력 (동 단위 권장)
  - 좌표 입력: 위도/경도 직접 입력 (선택사항)
- **검증**: 입력된 지역명의 유효성 검증
- **수집 범위**: 입력된 좌표를 중심으로 약 1.6km x 1.6km 영역의 모든 매물 수집 (동 단위 지역구 전체 커버)

#### 2.2.2 매물 수집 옵션
- **부동산 유형 선택**:
  - 아파트 (APT)
  - 아파트, 재건축 (APT:JGC)
  - 오피스텔 (OPST)
  - 빌라 (VL)
  - 아파트 분양권 (ABYG)
- **거래 유형 선택**:
  - 매매 (A1)
  - 전세 (B1)
  - 월세 (B2)
- **줌 레벨 설정**: 15~18 사이의 값 (기본값: 18)

#### 2.2.3 수집 실행
- **시작 버튼**: 매물 수집 시작
- **중지 버튼**: 진행 중인 수집 작업 중지
- **진행 상황 표시**: 
  - 진행률 프로그레스 바
  - 현재 수집 중인 지역 표시
  - 수집된 매물 개수 실시간 업데이트

#### 2.2.4 수집 로직 (ApiRef.md 기준 유지)
- **지역구 전체 매물 수집 전략**:
  - 입력된 지역의 좌표 범위를 계산하여 해당 지역구 전체를 커버하는 영역 설정
  - 영역을 체계적으로 작은 단위로 분할 (그리드 방식)
  - 각 그리드 영역을 순차적으로 API 호출하여 매물 수집
  - 줌 레벨 18 이상 사용하여 개별 매물이 최대한 많이 나타나도록 설정
  
- **다단계 수집 프로세스**:
  1. **1단계: 기본 영역 수집 (0-60%)**
     - 중심 좌표를 기준으로 넓은 영역을 그리드로 분할
     - 각 그리드에서 개별 매물(`count == 1`) 및 클러스터(`count > 1`) 정보 수집
     - 단지 정보(COMPLEX) 수집
  
  2. **2단계: 클러스터 확장 수집 (60-90%)**
     - 1단계에서 발견된 클러스터를 더 높은 줌 레벨(19-20)로 재수집
     - 클러스터 중심으로 매우 작은 영역(20-50m)을 설정하여 개별 매물 추출
     - 클러스터 크기에 따라 적응형으로 영역 크기 및 줌 레벨 조정
  
  3. **3단계: 데이터 정제 및 매칭 (90-100%)**
     - 중복 매물 제거 (itemId 기준)
     - 매물과 단지 정보 매칭 (lgeo 기반 우선, 좌표 기반 보조)
     - 단지명 할당 및 데이터 정제

- **영역 분할 전략**:
  - 기본 그리드 크기: 줌 레벨에 따라 자동 조정
    - 줌 19 이상: 10x10 그리드 (100개 영역)
    - 줌 18: 8x8 그리드 (64개 영역)
    - 줌 17 이하: 5x5 그리드 (25개 영역)
  - 넓은 지역의 경우 그리드 크기를 더 증가시켜 전체 영역 커버
  - 각 그리드 영역이 겹치지 않도록 정확히 계산

- **클러스터 처리 전략**:
  - 클러스터 발견 시 즉시 재수집하지 않고, 모든 기본 영역 수집 완료 후 일괄 처리
  - 클러스터 크기별 차등 처리:
    - 10개 이상: 50m 영역, 줌 19
    - 5-9개: 30m 영역, 줌 19
    - 5개 미만: 20m 영역, 줌 20
  - 최대 50개 클러스터까지 처리 (시간 고려)

### 2.3 관심 단지 시세/호가 텔레그램 알림 (요건 2)

#### 2.3.1 알림 대상
- 관심 단지(`TARGET_HOME_COMPLEX_NAME`)에 대해서만 알림 전송
- 배치 실행 시점에 자동으로 수집 및 분석 후 알림 전송

#### 2.3.2 전송 내용
1. **최근 시세 요약**
   - 최근 수집된 최저가 / 최고가
   - 대표 평형 기준 가격 범위
   - 표본 개수

2. **호가 분포 정보**
   - 평형대별 호가 분포 (상위 3개 평형대)
   - 동별 호가 차이 (가격 상/하위 동)

3. **최고가 상세 정보**
   - 최고가 매물의 동 / 층
   - 로얄동 / 로얄층 여부 판단 근거

4. **변동률 정보**
   - 전주 대비 변동률
   - 전월 대비 변동률
   - 전년 대비 변동률
   - 비교 기준일 명시

5. **갭 정보 (현재 거주 vs 관심단지)**
   - 대표평형 기준 가격 차이
   - 전체 호가 범위 비교

#### 2.3.3 텔레그램 메시지 포맷
```
[관심단지 리포트] {YYYY-MM-DD HH:mm}

🏢 관심단지: {TARGET_COMPLEX_NAME}
📍 기준: {SOURCE} / {TRADE_TYPE} / {AREA_BASIS} / {COLLECTED_AT}

━━━━━━━━━━━━━━━━
1) 최근가격(호가 요약)
• 전체: {MIN_PRICE}억 ~ {MAX_PRICE}억 (표본 {N_LISTINGS}개)
• 대표평형 {REP_PYEONG}평({REP_M2}㎡): {REP_MIN}억 ~ {REP_MAX}억 (표본 {REP_N}개)
• 최고가: {TOP_PRICE}억 / {TOP_DONG}동 {TOP_FLOOR}층 ({TOP_PYEONG}평) {TOP_TAGS}

━━━━━━━━━━━━━━━━
2) 변동률(전주/전월/전년)
(대표평형 {REP_PYEONG}평 기준 / 중앙값 또는 평균값: {STAT_BASIS})
• 전주 대비: {WOW_DELTA}억 ({WOW_PCT}%)
• 전월 대비: {MOM_DELTA}억 ({MOM_PCT}%)
• 전년 대비: {YOY_DELTA}억 ({YOY_PCT}%)
※ 비교 기준일: 주={WOW_DATE}, 월={MOM_DATE}, 년={YOY_DATE}

━━━━━━━━━━━━━━━━
3) 호가 분포(평형/동)
• 평형대별(상위 3)
  - {BKT1_PYEONG}평: {BKT1_MIN}~{BKT1_MAX}억 (중앙 {BKT1_MED}억, {BKT1_N}개)
  - {BKT2_PYEONG}평: {BKT2_MIN}~{BKT2_MAX}억 (중앙 {BKT2_MED}억, {BKT2_N}개)
  - {BKT3_PYEONG}평: {BKT3_MIN}~{BKT3_MAX}억 (중앙 {BKT3_MED}억, {BKT3_N}개)

• 동별(가격 상/하위)
  - 상위: {DONG_TOP1}동 중앙 {DONG_TOP1_MED}억 ({DONG_TOP1_N}개), {DONG_TOP2}동 중앙 {DONG_TOP2_MED}억
  - 하위: {DONG_LOW1}동 중앙 {DONG_LOW1_MED}억 ({DONG_LOW1_N}개), {DONG_LOW2}동 중앙 {DONG_LOW2_MED}억

━━━━━━━━━━━━━━━━
4) 갭 정보(현재 거주 vs 관심단지)
🏠 현재 거주: {CURRENT_COMPLEX_NAME}

• 대표평형 기준 갭({REP_PYEONG}평 기준)
  - 관심단지 중앙 {TGT_REP_MED}억 vs 거주단지 중앙 {CUR_REP_MED}억
  - 가격차이: {GAP_DELTA}억 ({GAP_PCT}%)

• 전체 호가 범위 비교
  - 관심: {TGT_MIN}~{TGT_MAX}억
  - 거주: {CUR_MIN}~{CUR_MAX}억

━━━━━━━━━━━━━━━━
🔗 단지 링크: {NAVER_LINK}
🗂 백데이터: {CSV_FILENAME}
```

### 2.4 가격 변동 알람 (요건 3)

#### 2.4.1 알람 조건
- 관심 단지의 호가 기준 가격이 아래 기준 대비 **하락**했을 경우 별도 텔레그램 알람 전송
- 비교 기준:
  - 전주 대비
  - 전월 대비
  - 전년 대비
- 배치 실행 시점에 자동으로 비교

#### 2.4.2 변동률 계산 방법
- **기준값(대표가격)**: 대표평형의 중앙값 P(t)
- **비교값**:
  - 전주: P(t - 7일) (없으면 가장 가까운 과거 수집일)
  - 전월: P(t - 30일) (없으면 가장 가까운 과거 수집일)
  - 전년: P(t - 365일) (없으면 가장 가까운 과거 수집일)
- **계산**:
  - 변화량(억): Δ = P_now - P_prev
  - 변동률(%): pct = (P_now - P_prev) / P_prev * 100
- **표시 규칙**:
  - 억 단위는 소수 둘째자리까지 (예: 0.35억)
  - %는 소수 첫째자리까지 (예: -2.1%)

#### 2.4.3 변동 메시지 포맷
```
🚨 [가격 변동 알림] {YYYY-MM-DD HH:mm}
🏢 {TARGET_COMPLEX_NAME} / 대표 {REP_PYEONG}평 기준

📉 변동률 요약({STAT_BASIS})
• 전주 대비: {WOW_DELTA}억 ({WOW_PCT}%)  {WOW_ARROW}
• 전월 대비: {MOM_DELTA}억 ({MOM_PCT}%)  {MOM_ARROW}
• 전년 대비: {YOY_DELTA}억 ({YOY_PCT}%)  {YOY_ARROW}

🔎 트리거: {TRIGGER_REASON}
- 기준: {TRIGGER_BASE} (예: 전주 대비 -0.35억 / -2.1%)
- 비교 기준일: 주={WOW_DATE}, 월={MOM_DATE}, 년={YOY_DATE}

🔗 {NAVER_LINK}
🗂 백데이터: {CSV_FILENAME}
```

### 2.5 Raw 데이터 저장 (요건 4)

#### 2.5.1 저장 규칙
- .env에 등록된 단지에 대한 모든 raw 수집 데이터는 CSV 형태로 저장
- 데이터베이스 사용 금지
- 기존 ApiRef.md 기준 수집 결과를 그대로 CSV로 적재

#### 2.5.2 저장 경로
```
data/raw/{complex_name}/offers_YYYYMMDD.csv
data/raw/{complex_name}/prices_YYYYMMDD.csv
```

#### 2.5.3 CSV 구조
- `offers_YYYYMMDD.csv`: 호가 정보 (매물 상세)
  - 컬럼: item_id, complex_name, property_type, trade_type, price, price_display, latitude, longitude, collected_at 등
- `prices_YYYYMMDD.csv`: 시세 정보 (단지별 집계)
  - 컬럼: complex_name, date, median_price, min_price, max_price, count 등

### 2.6 텔레그램 전송 백데이터 CSV 저장 (요건 5)

#### 2.6.1 저장 규칙
- 텔레그램으로 전송된 주요 메시지는 반드시 CSV로 백업
- 파일명에는 "전송 데이터 주제 + 전송일자"가 포함되어야 함

#### 2.6.2 파일명 규칙
```
telegram_price_summary_YYYYMMDD.csv
telegram_price_drop_alert_YYYYMMDD.csv
```

#### 2.6.3 CSV 컬럼 최소 요건
- `sent_at`: 전송 일시
- `complex_name`: 단지명
- `message_type`: 메시지 타입 (summary / drop_alert 등)
- `message_title`: 메시지 제목
- `message_body`: 메시지 본문
- `reference_price`: 기준 가격
- `comparison_target`: 비교 대상 (week / month / year)

## 3. 기술 스택

### 3.1 기존 기술 스택 (유지)
- Python 3.8+
- PySide6: GUI 프레임워크
- requests: HTTP 요청
- pandas: 데이터 처리
- openpyxl: 엑셀 파일 생성

### 3.2 추가 기술 스택
- python-telegram-bot 또는 requests (텔레그램 API)
- python-dotenv: .env 파일 로딩
- datetime, timedelta: 날짜 비교 및 계산

## 4. 프로젝트 폴더 구조 (요건 6)

```
project_root/
├─ src/
│ ├─ collectors/          # ApiRef.md 기반 수집 로직 (기존 유지)
│ │  ├─ __init__.py
│ │  ├─ api_client.py     # 기존 api_client.py 이동
│ │  └─ data_collector.py # 기존 data_collector.py 이동
│ ├─ processors/          # 가격 비교, 호가 분포 분석
│ │  ├─ __init__.py
│ │  ├─ price_analyzer.py # 가격 분석 및 변동률 계산
│ │  └─ distribution_analyzer.py # 호가 분포 분석
│ ├─ notifiers/
│ │  ├─ __init__.py
│ │  └─ telegram.py       # 텔레그램 전송 전용
│ ├─ storage/
│ │  ├─ __init__.py
│ │  └─ csv_store.py      # CSV 저장 공통 유틸
│ └─ config/
│    ├─ __init__.py
│    └─ env_loader.py    # .env 단지명 로딩
├─ data/
│ ├─ raw/                 # Raw 수집 데이터
│ │  └─ {complex_name}/
│ │     ├─ offers_YYYYMMDD.csv
│ │     └─ prices_YYYYMMDD.csv
│ └─ telegram_logs/       # 텔레그램 전송 백데이터
│    ├─ telegram_price_summary_YYYYMMDD.csv
│    └─ telegram_price_drop_alert_YYYYMMDD.csv
├─ PRD.md                 # 요건 1~6이 반영된 제품 요구사항 문서
├─ ApiRef.md              # 기존 수집 구조 문서 (변경 금지)
├─ .env.example           # .env 파일 예시
├─ .env                   # 실제 환경 변수 (gitignore)
├─ requirements.txt
└─ README.md
```

## 5. 데이터 흐름

### 5.1 수집 프로세스
1. .env 파일에서 관심 단지명 로드
2. 지역구 전체 매물 수집 (ApiRef.md 기준)
3. 관심 단지 필터링
4. Raw 데이터 CSV 저장 (`data/raw/{complex_name}/`)
5. 가격 분석 및 호가 분포 분석
6. 텔레그램 알림 전송 (요약 리포트)
7. 텔레그램 전송 백데이터 CSV 저장

### 5.2 가격 변동 알람 프로세스
1. 현재 수집 데이터와 과거 데이터 비교
2. 변동률 계산 (전주/전월/전년)
3. 하락 감지 시 텔레그램 알람 전송
4. 알람 백데이터 CSV 저장

## 6. 알림 시나리오

### 6.1 정기 리포트 (요건 2)
- **트리거**: 배치 실행 시점
- **대상**: 관심 단지 (`TARGET_HOME_COMPLEX_NAME`)
- **내용**: 시세 요약, 호가 분포, 변동률, 갭 정보
- **주기**: 수집 실행 시마다

### 6.2 가격 변동 알람 (요건 3)
- **트리거**: 가격 하락 감지 시
- **대상**: 관심 단지 (`TARGET_HOME_COMPLEX_NAME`)
- **조건**: 전주/전월/전년 대비 하락
- **내용**: 변동률 요약 및 트리거 정보

## 7. 구현 제약사항

### 7.1 기존 구조 유지
- ApiRef.md를 기준으로 한 기존 수집 로직은 변경하지 않음
- 기존 API 호출 방식, 파싱 로직 유지
- 기존 데이터 구조 유지

### 7.2 데이터베이스 미사용
- 모든 데이터는 CSV 파일로 저장
- 데이터베이스 관련 라이브러리 사용 금지

### 7.3 하드코딩 금지
- 단지명은 .env 파일에서만 로드
- 코드에 단지명 직접 입력 금지
